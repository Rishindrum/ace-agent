name: Deploy to Google Cloud

on:
  push:
    branches:
      - main  # Runs every time you push to main

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: us-central1
  REPO_NAME: ace-repo

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. Login to Google Cloud
      - name: Authenticate with Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Configure Docker
        run: gcloud auth configure-docker us-central1-docker.pkg.dev

      # 2. Build & Push Python (The Brain)
      - name: Build and Push Python
        run: |
          IMAGE_URL=us-central1-docker.pkg.dev/$PROJECT_ID/$REPO_NAME/backend-python:latest
          docker build -t $IMAGE_URL ./backend-python
          docker push $IMAGE_URL

      # 3. Deploy Python to Cloud Run
      - name: Deploy Python Service
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: backend-python
          image: us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/ace-repo/backend-python:latest
          region: us-central1
          env_vars: |
            GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
            NEO4J_URI=${{ secrets.NEO4J_URI }}
            NEO4J_PASSWORD=${{ secrets.NEO4J_PASSWORD }}
            PYTHONUNBUFFERED=1

      # 4. Build & Push Go (The Gateway)
      - name: Build and Push Go
        run: |
          IMAGE_URL=us-central1-docker.pkg.dev/$PROJECT_ID/$REPO_NAME/backend-go:latest
          docker build -t $IMAGE_URL ./backend-go
          docker push $IMAGE_URL

      # 5. Get Python URL (To tell Go where Brain is)
      - name: Get Python URL
        run: echo "PYTHON_URL=$(gcloud run services describe backend-python --region us-central1 --format 'value(status.url)')" >> $GITHUB_ENV

      # 6. Deploy Go to Cloud Run
      - name: Deploy Go Service
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: backend-go
          image: us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/ace-repo/backend-go:latest
          region: us-central1
          env_vars: |
            PYTHON_SERVICE_URL=${{ env.PYTHON_URL }}