name: Build and Push to GCP

on:
  push:
    branches: [ "main" ]

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: us-central1
  # This MUST match the repository_id in your infra/main.tf
  REPO_NAME: ace-agent-repo

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    # We removed 'id-token: write' because the JSON key doesn't need it
    permissions:
      contents: read

    strategy:
      matrix:
        service: [backend-go, backend-python, frontend-angular]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # CHANGED: Authenticate using the JSON Key secret
    - name: Google Auth
      id: auth
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    # 2. Set up the Cloud SDK
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    # 3. Configure Docker to talk to Google Artifact Registry
    - name: Configure Docker Auth
      run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

    # 4. Build and Push (With both SHA and Latest tags)
    - name: Build and Push ${{ matrix.service }}
      uses: docker/build-push-action@v5
      with:
        context: ./${{ matrix.service }}
        file: ./${{ matrix.service }}/Dockerfile
        push: true
        tags: |
          ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ matrix.service }}:${{ github.sha }}
          ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ matrix.service }}:latest